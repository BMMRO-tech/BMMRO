## Data export script

This script exports data from the Firebase Firestore to a csv file.

## Installation

It is assumed that at this point, you have `node`, `git`, `npm` and a terminal installed on your system.

1. Clone the repository onto your machine: `git clone https://github.com/BMMRO-tech/BMMRO.git`
2. Navigate to the `export-script` folder `cd export-script`
3. Install the dependencies `npm ci`
4. Create a `.env` file (`touch .env`) and set the following values that can be found in project settings inside firebaseConfig object in Firebase console:

- set `PROJECT_ID` to `projectId`
- set `API_KEY` to `apiKey`
- set `AUTH_DOMAIN` to `authDomain`
- set `EMAIL` and `PASSWORD` to your email address and password that you use to log in to the app

## Running the script

The script can be executed in this manner: `node index.js <start date> <end date> [options]`.

You will need to specify a date range to export the data entries from. First argument passed to the command is a start date (entries from this date will be included) and second argument is an end date (entries from this date will be excluded). Dates need to be in `dd/mm/yyyy` format, for example:

```
node index.js 01/06/2020 01/07/2020
```

This will generate two files inside a folder called `exported`. One file will contain `habitatUse` entries and the other will contain `encounter` entries.

By default, the script will only export entries that have not previously been exported (`exported` field set as false). To get _all_ entries in the specified date range, regardless of whether they've previously been exported, you may specify a `--all` flag for the command, for example:

```
node index.js 01/06/2020 01/07/2020 --all
```

By default, the script will mark all entries as exported (set the `exported` field to true). If you need to override this behavior, you may specify a `--no-mark` flag to export entries within your date range _without_ marking them as exported:

```
node index.js 01/06/2020 01/07/2020 --no-mark
```

To see an autogenerated help message, run `node index.js --help`.

## Limitations

This script leverages the cloud firestore batch update function to mark entries as exported, so that we can ensure all specified entries are either marked as exported or the entire operation fails. Each batch may modify a maximum of 500 entries. If in your usage of this script, you try to mark more than 500 entries, the script will fail and you will be asked to narrow your date range.

The documentation for the cloud firestore batch updates can be found [here](https://firebase.google.com/docs/firestore/manage-data/transactions).

## Running tests

Run the following command to run script tests:

```
npm test
```

## Importing a csv file to Microsoft Access database

1. Open a database file.
2. Go to `External Data`.
3. Click on `New Data Source` -> `From File` -> `Text File`.
4. Specify the csv file as the source of your data.
5. Select `Append a copy of the records to the table` and choose the table you want to import data to from a dropdown menu.
6. Select import in a delimited format.
7. Click on `Advanced…` and make sure that:

- Date Order is set to `MDY`
- Date Delimiter is set to `/`
- Time Delimiter is set to `:`
- Four Digit Years checkbox is selected
- Leading Zeros in Dates field is not selected

8.  On the next page, select comma delimited and click the `First Row Contains Field Names` checkbox.
