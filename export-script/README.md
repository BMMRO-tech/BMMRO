## Data export script

This script exports data from the Firebase Firestore to a csv file.

## Installation

**NOTE:** You will need to install `node` and `npm` from https://nodejs.org/en/download/ before you run the export script for the first time.

You will need to do the following everytime there's a significant change on the export script:

1. Get the code from GitHub by going to the [GitHub page for the project](https://github.com/BMMRO-tech/BMMRO), clicking 'Code' and selecting 'Download ZIP'. Optionally, you can also clone the repository onto your machine: `git clone https://github.com/BMMRO-tech/BMMRO.git`, but you will need to [download `git`](https://git-scm.com/downloads) first.
1. Go to the `export-script` folder and create a file named `.env` with the following content:

```
PROJECT_ID=123
API_KEY=123
AUTH_DOMAIN=123
EMAIL=123
PASSWORD=123
```

Please replace `123` with the correct values which can be found inside the firebaseConfig object at the bottom of the settings page. These values will be different depending on the environment you want to export data from. For example, for the development environment, these values can be found on [this page in the Firebase console](https://console.firebase.google.com/u/1/project/bmmro-164ec/settings/general)). `EMAIL` and `PASSWORD` are the email address and password that you use to log in to the app.

1. Open your terminal/command prompt.
1. Navigate to the `export-script` folder.
1. Install the dependencies with `npm ci`.
1. You should now be able to generate the CSV. Please check the section below to see the different options.

## Running the script

The script can be executed in this manner: `node index.js <start date> <end date> [options]`.

You will need to specify a date range to export the data entries from. First argument passed to the command is a start date (entries from this date will be included) and second argument is an end date (entries from this date will be excluded). Dates need to be in `dd/mm/yyyy` format, for example:

```
node index.js 01/06/2020 01/07/2020
```

This will generate two files inside a folder called `exported`. One file will contain `habitatUse` entries and the other will contain `encounter` entries.

By default, the script will only export entries that have not previously been exported (`exported` field set as false). To get _all_ entries in the specified date range, regardless of whether they've previously been exported, you may specify a `--all` flag for the command, for example:

```
node index.js 01/06/2020 01/07/2020 --all
```

By default, the script will mark all entries as exported (set the `exported` field to true). If you need to override this behavior, you may specify a `--no-mark` flag to export entries within your date range _without_ marking them as exported:

```
node index.js 01/06/2020 01/07/2020 --no-mark
```

To see an autogenerated help message, run `node index.js --help`.

## Limitations

This script leverages the cloud firestore batch update function to mark entries as exported, so that we can ensure all specified entries are either marked as exported or the entire operation fails. Each batch may modify a maximum of 500 entries. If in your usage of this script, you try to mark more than 500 entries, the script will fail and you will be asked to narrow your date range.

The documentation for the cloud firestore batch updates can be found [here](https://firebase.google.com/docs/firestore/manage-data/transactions).

## Running tests

Run the following command to run script tests: `npm test`

## Importing a csv file to Microsoft Access database

1. Open a database file.
2. Go to `External Data`.
3. Click on `New Data Source` -> `From File` -> `Text File`.
4. Specify the csv file as the source of your data.
5. Select `Append a copy of the records to the table` and choose the table you want to import data to from a dropdown menu.
6. Select import in a delimited format.
7. Click on `Advanced…` and make sure that:

- Date Order is set to `MDY`
- Date Delimiter is set to `/`
- Text Qualifier is set to `"`
- Time Delimiter is set to `:`
- Four Digit Years checkbox is selected
- Leading Zeros in Dates field is not selected

8.  On the next page, select comma delimited and click the `First Row Contains Field Names` checkbox.

## Notes

A change in the Microsoft Access database without updating this export script accordingly might cause the import to fail. This change could be, for example, removing a field, changing the field type or validation (e.g., maximum length), ...
Adding new fields to MS Access but not in Firestore, should not cause any issues. Imported records will just take the default values for those fields.
