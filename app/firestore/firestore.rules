service cloud.firestore {
  match /databases/{database}/documents {
    match /habitatUse/{habitatUseId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && habitatUseValidation(request.resource.data);
      allow update, delete: if false;
    }
  }
}

function habitatUseValidation(fireData) {
  return validateIntegerValue('encSeqNo', fireData.encSeqNo, 0, 99, true) &&
    validateIntegerValue('numberOfAnimals', fireData.numberOfAnimals, 0, 99, true) &&
    validateIntegerValue('numberOfCalves', fireData.numberOfCalves, 0, 99, true) &&
    validateIntegerValue('numberOfBoats', fireData.numberOfBoats, 0, 999, true) &&
    validateIntegerValue('surfaceBout', fireData.surfaceBout, 0, 99, true) &&
    validateFloatValue('waterDepth', fireData.waterDepth, 0, 9999, true) &&
    validateFloatValue('distance', fireData.distance, 0, 9999, true) &&
    validateFloatValue('bearing', fireData.bearing, 0, 360, true) &&
    validateFloatValue('aspect', fireData.aspect, 0, 360, true) &&
    validateFloatValue('waterTemp', fireData.waterTemp, 15, 40, true) &&
    validateStringValue('groupComposition', fireData.groupComposition, 100, true) &&
    validateStringValue('species', fireData.species, 100, true) &&
    validateStringValue('directionOfTravel', fireData.directionOfTravel, 100, true) &&
    validateStringValue('bottomSubstrate', fireData.bottomSubstrate, 100, true) &&
    validateStringValue('cloudCover', fireData.cloudCover, 100, true) &&
    validateStringValue('beaufortSeaState', fireData.beaufortSeaState, 100, true) &&
    validateStringValue('tideState', fireData.tideState, 100, true) &&
    validateStringValue('behaviour', fireData.behaviour, 100, true) &&
    validateStringValue('swellWaveHeight', fireData.swellWaveHeight, 100, true) &&
    validateStringValue('groupCohesion', fireData.groupCohesion, 100, true) &&
    validateStringValue('comments', fireData.comments, 500, true) &&
    validatePosition('latitude', fireData.latitude, -90, 90) &&
    validatePosition('longitude', fireData.longitude, -180, 180) &&
    validateDateValue('date', fireData.date) &&
    validateTimeValue('startTime', fireData.startTime, false) &&
    validateTimeValue('endTime', fireData.endTime, true);
}

function validateMissingField(field) {
  return field in request.resource.data;
}

function validateNumber(val) {
  return val is number;
}

function validateInteger(val) {
  return val is int;
}

function validateString(val) {
  return val is string;
}

function validateEmptyString(val) {
  return val.size() != 0;
}

function validateRange(val, min, max) {
  return val >= min && val <= max;
}

function validatePositionFormat(val) {
  return string(val).matches('^-?[0-9]*.[0-9]{6}$');
}

function validateDateFormat(val) {
  return string(val).matches('^[0-9]{1,2}/[0-9]{1,2}/[0-9]{4}$');
}

function validateTimeFormat(val) {
  return string(val).matches('^[0-9]{1,2}:[0-9]{1,2}$');
}

function validateMaxCharLength(val, max) {
  return val.size() <= max;
}

function validateFloatValue(field, val, min, max, optional) {
  return (val == "" && optional) ? true : validateNumber(val) && validateRange(val, min, max);
}

function validateIntegerValue(field, val, min, max, optional) {
  return (val == "" && optional) ? true : validateInteger(val) && validateRange(val, min, max);
}

function validatePosition(field, val, min, max) {
  return validateFloatValue(field, float(val), min, max, false) && validatePositionFormat(val);
}

function validateStringValue(field, val, max, optional) {
  return (val == "" && optional) ? true : validateString(val) && validateEmptyString(val) && validateMaxCharLength(val, max);
}

function validateDateValue(field, val) {
  return validateDateFormat(val);
}

function validateTimeValue(field, val, optional) {
  return (val == "" && optional) ? true : validateTimeFormat(val);
}